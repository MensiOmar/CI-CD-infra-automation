---
# tasks file for add_jenkin_nodes
- name: set jenkins groovy script to create a new node
  ansible.builtin.set_fact:
    add_jenkins_node_script: |
      import hudson.model.Node.Mode
      import hudson.slaves.*
      import jenkins.model.Jenkins
      import hudson.plugins.sshslaves.*
      import hudson.plugins.sshslaves.SSHLauncher
      import hudson.plugins.sshslaves.verifiers.*

      SshHostKeyVerificationStrategy hostKeyVerificationStrategy = new NonVerifyingKeyVerificationStrategy()
      // The "build" object is added by the Jenkins Groovy plugin and can resolve parameters and such
      String credentialID = "{{slave_credential_id}}"
      String agentName = "{{slave_name}}"
      String agentDescription = 'ssh slave'
      String agentIP = "{{slave_ip_host}}"

      // Other parameters are just hard coded for now, adjust as needed
      String agentHome = "/home/jenkins/agent"
      String agentExecutors = 1
      String agentLabels = ""
      //if (agentName.contains("engine")) {
        //  agentLabels += " engine"
        //  println "That agent was for an engine builder, so updated label: $agentLabels"
      //}
      ComputerLauncher launcher = new SSHLauncher(
        agentIP, // Host
        credentialID , // Credentials ID
        {{ssh_agent_container_port}}, // port
        null, // JavaPath
        null, // JVM Options
        null, // Prefix Start Agent Command
        null, // Suffix Start Agent Command
        false, // Log environment on initial connect
        serverKeyVerificationStrategy // Host Key Verification Strategy
        
      )
      // There is a constructor that also takes a list of properties (env vars) at the end, but haven't needed that yet
      DumbSlave dumb = new DumbSlave(
              agentName, // Agent name, usually matches the host computer's machine name
              agentDescription, // Agent description
              agentHome, // Workspace on the agent's computer
              agentExecutors, // Number of executors
              Mode.EXCLUSIVE, // "Usage" field, EXCLUSIVE is "only tied to node", NORMAL is "any"
              agentLabels, // Labels
              launcher,
              RetentionStrategy.INSTANCE) // Is the "Availability" field and INSTANCE means "Always"
      Jenkins.instance.addNode(dumb)
      println "Agent '$agentName' created with $agentExecutors executors and home '$agentHome'"

- name: add ssh agent credentials to jenkins master
  community.general.jenkins_script:
    script: "{{add_jenkins_node_script}}"
    user: "{{jenkins_user}}"
    password: "{{jenkins_password}}"
    url: "{{jenkins_url}}"
    validate_certs: false